<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¤‘ê³  ê²½ë§¤ AltTap</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-top">
          <h1>
            <i data-lucide="gavel"></i>
            ì¤‘ê³  ê²½ë§¤ í”Œë«í¼
          </h1>
          <div class="user-menu">
            <span class="username"
              ><i data-lucide="user"></i> <%= user.username %>ë‹˜</span
            >
            <button class="logout-button" onclick="logout()">
              <i data-lucide="log-out"></i>
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
        <p class="subtitle">ì‹¤ì‹œê°„ ê²½ë§¤ë¡œ ì¤‘ê³  ë¬¼í’ˆì„ ê±°ë˜í•˜ì„¸ìš”</p>

        <div class="user-info">
          <div class="user-balance">
            <i data-lucide="wallet"></i>
            <span>ì”ì•¡:</span>
            <span class="balance-amount" id="userBalance">ë¡œë”© ì¤‘...</span>
          </div>
          <button class="add-item-button" onclick="openAddItemModal()">
            <i data-lucide="plus-circle"></i>
            ìƒí’ˆ ë“±ë¡
          </button>
        </div>
      </header>

      <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('auction')">
          <i data-lucide="gavel"></i>
          ê²½ë§¤
        </button>
        <button class="nav-tab" onclick="switchTab('community')">
          <i data-lucide="message-square"></i>
          ì»¤ë®¤ë‹ˆí‹°
        </button>
        <a
          href="/admin"
          class="nav-tab admin-button"
          id="adminTab"
          style="display: none"
        >
          <i data-lucide="shield"></i>
          ê´€ë¦¬ì
        </a>
      </div>

      <!-- ê²½ë§¤ íƒ­ -->
      <div id="auctionTab" class="tab-content">
        <div id="itemsContainer" class="items-grid">
          <div class="loading">
            <i data-lucide="loader"></i>
            ê²½ë§¤ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>

      <!-- ì»¤ë®¤ë‹ˆí‹° íƒ­ -->
      <div id="communityTab" class="tab-content" style="display: none">
        <button
          class="add-item-button"
          onclick="openPostModal()"
          style="margin-bottom: 20px"
        >
          <i data-lucide="plus"></i>
          ê²Œì‹œê¸€ ì‘ì„±
        </button>
        <div id="postsContainer">
          <div class="loading">
            <i data-lucide="loader"></i>
            ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="addItemModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ìƒí’ˆ ë“±ë¡</h2>
          <button class="close-button" onclick="closeAddItemModal()">
            <i data-lucide="x"></i>
          </button>
        </div>
        <form id="addItemForm" onsubmit="submitNewItem(event)">
          <div class="form-group">
            <label class="form-label">ìƒí’ˆëª…</label>
            <input type="text" class="form-input" id="itemTitle" required />
          </div>
          <div class="form-group">
            <label class="form-label">ìƒí’ˆ ì„¤ëª…</label>
            <textarea
              class="form-textarea"
              id="itemDescription"
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">ì‹œì‘ ê°€ê²© (ì›)</label>
            <input
              type="number"
              class="form-input"
              id="itemPrice"
              min="1000"
              step="1000"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">ì¦‰ì‹œ êµ¬ë§¤ê°€ (ì›, ì„ íƒì‚¬í•­)</label>
            <input
              type="number"
              class="form-input"
              id="itemBuyNowPrice"
              min="1000"
              step="1000"
              placeholder="ì¦‰ì‹œ êµ¬ë§¤ê°€ë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”"
            />
            <small style="color: #94a3b8; margin-top: 5px; display: block"
              >ì‹œì‘ ê°€ê²©ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤</small
            >
          </div>
          <div class="form-group">
            <label class="form-label">ê²½ë§¤ ì¢…ë£Œ ì‹œê°„</label>
            <input
              type="datetime-local"
              class="form-input"
              id="itemEndTime"
              required
            />
          </div>
          <button type="submit" class="submit-button">
            <i data-lucide="check"></i>
            ë“±ë¡í•˜ê¸°
          </button>
        </form>
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ì‘ì„± ëª¨ë‹¬ -->
    <div id="postModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ê²Œì‹œê¸€ ì‘ì„±</h2>
          <button class="close-button" onclick="closePostModal()">
            <i data-lucide="x"></i>
          </button>
        </div>
        <form id="postForm" onsubmit="submitPost(event)">
          <div class="form-group">
            <label class="form-label">ì œëª©</label>
            <input type="text" class="form-input" id="postTitle" required />
          </div>
          <div class="form-group">
            <label class="form-label">ë‚´ìš©</label>
            <textarea
              class="form-textarea"
              id="postContent"
              required
              style="min-height: 200px"
            ></textarea>
          </div>
          <button type="submit" class="submit-button">
            <i data-lucide="check"></i>
            ì‘ì„±í•˜ê¸°
          </button>
        </form>
      </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div id="notification" class="notification">
      <i data-lucide="check-circle"></i>
      <span id="notificationMessage"></span>
    </div>

    <script>
      const API_BASE = '/api';
      const CURRENT_USER_ID = <%= user.id %>;
      let currentTab = 'auction';

      lucide.createIcons();

      // íƒ­ ì „í™˜
      function switchTab(tab, fromEvent = true) {
          currentTab = tab;

          document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

          // ì´ë²¤íŠ¸ì—ì„œ í˜¸ì¶œëœ ê²½ìš°ë§Œ active í´ë˜ìŠ¤ ì¶”ê°€
          if (fromEvent && event && event.target) {
              event.target.closest('.nav-tab').classList.add('active');
          } else {
              // í”„ë¡œê·¸ë˜ë§¤í‹± í˜¸ì¶œì˜ ê²½ìš° í•´ë‹¹ íƒ­ ë²„íŠ¼ ì°¾ì•„ì„œ active ì¶”ê°€
              const tabs = {
                  'auction': 0,
                  'community': 1,
              };
              const tabButtons = document.querySelectorAll('.nav-tab');
              if (tabButtons[tabs[tab]]) {
                  tabButtons[tabs[tab]].classList.add('active');
              }
          }

          document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

          if (tab === 'auction') {
              document.getElementById('auctionTab').style.display = 'block';
              loadItems();
          } else if (tab === 'community') {
              document.getElementById('communityTab').style.display = 'block';
              loadPosts();
          }

          lucide.createIcons();
      }

      // ê´€ë¦¬ì í™•ì¸
      async function checkAdmin() {
          try {
              const response = await fetch('/auth/me');
              const data = await response.json();
              if (data.success && data.user.role === 'admin') {
                  document.getElementById('adminTab').style.display = 'flex';
              }
          } catch (error) {
              console.error('ê´€ë¦¬ì í™•ì¸ ì—ëŸ¬:', error);
          }
      }

      async function logout() {
          try {
              const response = await fetch('/auth/logout', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
              });
              const data = await response.json();
              if (data.success) window.location.href = '/login';
          } catch (error) {
              console.error('ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:', error);
          }
      }

      async function loadUserInfo() {
          try {
              const response = await fetch('/auth/me');
              const data = await response.json();
              if (data.success) {
                  document.getElementById('userBalance').textContent = formatPrice(data.user.balance) + 'ì›';
              }
          } catch (error) {
              console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì—ëŸ¬:', error);
          }
      }

      // ===== ê²½ë§¤ ê¸°ëŠ¥ =====
      async function loadItems() {
          try {
              const response = await fetch(`${API_BASE}/items`);
              const data = await response.json();
              if (data.success) displayItems(data.items);
          } catch (error) {
              console.error('ìƒí’ˆ ë¡œë“œ ì—ëŸ¬:', error);
          }
      }

      function displayItems(items) {
          const container = document.getElementById('itemsContainer');
          if (items.length === 0) {
              container.innerHTML = '<div class="loading">ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
              lucide.createIcons();
              return;
          }

          container.innerHTML = items.map(item => {
              const endTime = new Date(item.end_time);
              const timeRemaining = getTimeRemaining(endTime);
              const isOwner = item.seller_id === CURRENT_USER_ID;

              return `
                  <div class="item-card">
                      <div class="item-header">
                          <h3 class="item-title">${item.title}</h3>
                          <span class="item-status">
                              <i data-lucide="zap" style="width: 14px; height: 14px;"></i>
                              ì§„í–‰ì¤‘
                          </span>
                      </div>
                      <p class="item-description">${item.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                      <div class="item-price">
                          <div class="price-label">í˜„ì¬ê°€</div>
                          <div class="price-amount">${formatPrice(item.current_price)}ì›</div>
                      </div>
                      ${item.buy_now_price ? `
                          <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                              <div style="font-size: 0.85em; opacity: 0.9;">ì¦‰ì‹œ êµ¬ë§¤ê°€</div>
                              <div style="font-size: 1.5em; font-weight: bold; margin-top: 3px;">${formatPrice(item.buy_now_price)}ì›</div>
                          </div>
                      ` : ''}
                      <div class="item-meta">
                          <div class="meta-item">
                              <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                              ${item.seller_name}
                          </div>
                          <div class="meta-item">
                              <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                              ${timeRemaining}
                          </div>
                          <div class="meta-item">
                              <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                              ${item.bid_count}íšŒ ì…ì°°
                          </div>
                      </div>
                      ${isOwner ? `
                          <div class="item-actions">
                              <button class="delete-button" onclick="deleteItem(${item.id})">
                                  <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                  ì‚­ì œ
                              </button>
                          </div>
                      ` : `
                          <div class="item-actions">
                              ${item.buy_now_price ? `
                                  <button class="chat-button" style="background: #f59e0b;" onclick="buyNow(${item.id}, ${item.buy_now_price})">
                                      <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                                      ì¦‰ì‹œ êµ¬ë§¤
                                  </button>
                              ` : ''}
                          </div>
                      `}
                      <div class="bid-section">
                          <input type="number" class="bid-input" id="bid-${item.id}"
                                 placeholder="ì…ì°°ê°€ ì…ë ¥" min="${parseInt(item.current_price) + 1000}" step="1000">
                          <button class="bid-button" onclick="placeBid(${item.id})">
                              <i data-lucide="gavel" style="width: 18px; height: 18px;"></i>
                              ì…ì°°
                          </button>
                      </div>
                  </div>
              `;
          }).join('');
          lucide.createIcons();
      }

      async function placeBid(itemId) {
          const bidInput = document.getElementById(`bid-${itemId}`);
          const bidAmount = parseInt(bidInput.value);
          if (!bidAmount) {
              showNotification('ì…ì°°ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
              return;
          }

          try {
              const response = await fetch(`${API_BASE}/bids`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ itemId, userId: CURRENT_USER_ID, bidAmount })
              });
              const data = await response.json();
              if (data.success) {
                  showNotification('ì…ì°°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'success');
                  bidInput.value = '';
                  loadItems();
                  loadUserInfo();
              } else {
                  showNotification(data.message, 'error');
              }
          } catch (error) {
              console.error('ì…ì°° ì—ëŸ¬:', error);
              showNotification('ì…ì°°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
      }

      async function deleteItem(itemId) {
          if (!confirm('ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

          try {
              const response = await fetch(`${API_BASE}/items/${itemId}`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: CURRENT_USER_ID })
              });
              const data = await response.json();
              if (data.success) {
                  showNotification('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                  loadItems();
              } else {
                  showNotification(data.message, 'error');
              }
          } catch (error) {
              console.error('ì‚­ì œ ì—ëŸ¬:', error);
              showNotification('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
      }

      function openAddItemModal() {
          document.getElementById('addItemModal').classList.add('active');
          lucide.createIcons();
      }

      function closeAddItemModal() {
          document.getElementById('addItemModal').classList.remove('active');
          document.getElementById('addItemForm').reset();
      }

      async function submitNewItem(event) {
          event.preventDefault();
          const title = document.getElementById('itemTitle').value;
          const description = document.getElementById('itemDescription').value;
          const startingPrice = document.getElementById('itemPrice').value;
          const buyNowPrice = document.getElementById('itemBuyNowPrice').value;
          const endTime = document.getElementById('itemEndTime').value;

          // ì¦‰ì‹œ êµ¬ë§¤ê°€ ìœ íš¨ì„± ê²€ì‚¬
          if (buyNowPrice && parseFloat(buyNowPrice) <= parseFloat(startingPrice)) {
              showNotification('ì¦‰ì‹œ êµ¬ë§¤ê°€ëŠ” ì‹œì‘ ê°€ê²©ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.', 'error');
              return;
          }

          try {
              const response = await fetch(`${API_BASE}/items`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      sellerId: CURRENT_USER_ID,
                      title,
                      description,
                      startingPrice,
                      buyNowPrice: buyNowPrice || null,
                      endTime
                  })
              });
              const data = await response.json();
              if (data.success) {
                  showNotification('ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                  closeAddItemModal();
                  loadItems();
              } else {
                  showNotification(data.message, 'error');
              }
          } catch (error) {
              console.error('ìƒí’ˆ ë“±ë¡ ì—ëŸ¬:', error);
              showNotification('ìƒí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
      }

      // ì¦‰ì‹œ êµ¬ë§¤
      async function buyNow(itemId, price) {
          if (!confirm(`â‚©${formatPrice(price)}ì›ì— ì´ ìƒí’ˆì„ ì¦‰ì‹œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nêµ¬ë§¤ í›„ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`)) {
              return;
          }

          try {
              const response = await fetch(`${API_BASE}/buy-now`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      itemId,
                      userId: CURRENT_USER_ID
                  })
              });
              const data = await response.json();

              if (data.success) {
                  showNotification(`ğŸ‰ ${data.message} ë‚¨ì€ ì”ì•¡: â‚©${formatPrice(data.data.remainingBalance)}`, 'success');
                  loadItems();
                  loadUserInfo(); // ì”ì•¡ ì—…ë°ì´íŠ¸
              } else {
                  if (data.required && data.current) {
                      showNotification(`${data.message}\ní•„ìš”: â‚©${formatPrice(data.required)}, í˜„ì¬: â‚©${formatPrice(data.current)}`, 'error');
                  } else {
                      showNotification(data.message, 'error');
                  }
              }
          } catch (error) {
              console.error('ì¦‰ì‹œ êµ¬ë§¤ ì—ëŸ¬:', error);
              showNotification('ì¦‰ì‹œ êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
      }

      // ===== ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ =====
      async function loadPosts() {
          try {
              const response = await fetch('/api/community/posts');
              const data = await response.json();
              if (data.success) displayPosts(data.posts);
          } catch (error) {
              console.error('ê²Œì‹œê¸€ ë¡œë“œ ì—ëŸ¬:', error);
          }
      }

      function displayPosts(posts) {
          const container = document.getElementById('postsContainer');
          if (posts.length === 0) {
              container.innerHTML = '<div class="loading">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
              return;
          }

          container.innerHTML = posts.map(post => `
              <div class="post-card">
                  <div class="post-header">
                      <h3 class="post-title">${post.title}</h3>
                      <div class="post-meta">
                          <span>${post.username}</span> Â·
                          <span>${new Date(post.created_at).toLocaleDateString()}</span>
                      </div>
                  </div>
                  <p class="post-content">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                  <div class="post-stats">
                      <span><i data-lucide="eye" style="width: 14px; height: 14px;"></i> ${post.views}</span>
                      <span><i data-lucide="message-square" style="width: 14px; height: 14px;"></i> ${post.comment_count}</span>
                  </div>
              </div>
          `).join('');
          lucide.createIcons();
      }

      function openPostModal() {
          document.getElementById('postModal').classList.add('active');
          lucide.createIcons();
      }

      function closePostModal() {
          document.getElementById('postModal').classList.remove('active');
          document.getElementById('postForm').reset();
      }

      async function submitPost(event) {
          event.preventDefault();
          const title = document.getElementById('postTitle').value;
          const content = document.getElementById('postContent').value;

          try {
              const response = await fetch('/api/community/posts', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: CURRENT_USER_ID, title, content })
              });
              const data = await response.json();
              if (data.success) {
                  showNotification('ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                  closePostModal();
                  loadPosts();
              } else {
                  showNotification(data.message, 'error');
              }
          } catch (error) {
              console.error('ê²Œì‹œê¸€ ì‘ì„± ì—ëŸ¬:', error);
              showNotification('ê²Œì‹œê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
      }

      // ===== ìœ í‹¸ë¦¬í‹° =====
      function showNotification(message, type = 'success') {
          const notification = document.getElementById('notification');
          const messageEl = document.getElementById('notificationMessage');
          messageEl.textContent = message;
          notification.className = `notification ${type} active`;
          setTimeout(() => notification.classList.remove('active'), 3000);
      }

      function formatPrice(price) {
          return new Intl.NumberFormat('ko-KR').format(price);
      }

      function getTimeRemaining(endTime) {
          const now = new Date();
          const diff = endTime - now;
          if (diff <= 0) return 'ì¢…ë£Œ';
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          if (hours > 24) {
              const days = Math.floor(hours / 24);
              return `${days}ì¼ ë‚¨ìŒ`;
          }
          return `${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
      }

      // ì´ˆê¸°í™”
      checkAdmin();
      loadUserInfo();
      loadItems();

      // ê²½ë§¤ì™€ ì»¤ë®¤ë‹ˆí‹°ëŠ” 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
      setInterval(() => {
          if (currentTab === 'auction') loadItems();
          else if (currentTab === 'community') loadPosts();
      }, 5000);

      setInterval(loadUserInfo, 10000);
    </script>
  </body>
</html>
